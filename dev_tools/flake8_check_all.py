# flake8_check_all.py ‚Äî —É—Ç–∏–ª—ñ—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫—É flake8 –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–º –≤–∏–≤–æ–¥–æ–º
# –î–æ–¥–∞—î –æ–ø—Ü—ñ—ó: --exclude, --output, –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –ø–æ–º–∏–ª–æ–∫.

import argparse
import shutil
import subprocess
import sys

# –°–ª–æ–≤–Ω–∏–∫ –∑ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏ –ø–æ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏—Ö –ø–æ–º–∏–ª–∫–∞—Ö flake8
HINTS = {
    "E302": "E302: –ø–æ—Ç—Ä—ñ–±–Ω–æ 2 –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü—ñ—î—é/–∫–ª–∞—Å–æ–º.",
    "E305": "E305: –ø–æ—Ç—Ä—ñ–±–Ω–æ 2 –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ –ø—ñ—Å–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó/–∫–ª–∞—Å—É.",
    "F401": "F401: —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ, –∞–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ ‚Üí –ø—Ä–∏–±–µ—Ä–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π —ñ–º–ø–æ—Ä—Ç.",
    "E501": "E501: —Ä—è–¥–æ–∫ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π ‚Üí —Ä–æ–∑–±–∏–π –Ω–∞ –∫—ñ–ª—å–∫–∞ —Ä—è–¥–∫—ñ–≤ –∞–±–æ"
    " –ø–µ—Ä–µ–≤—ñ—Ä—å max-line-length.",
    "W291": "W291: –ø—Ä–æ–±—ñ–ª–∏ –≤ –∫—ñ–Ω—Ü—ñ —Ä—è–¥–∫–∞ ‚Üí –≤–∏–¥–∞–ª–∏ —ó—Ö.",
    "W293": "W293: –∑–∞–π–≤—ñ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ –∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏ ‚Üí –æ—á–∏—Å—Ç–∏ —ó—Ö.",
    "F841": "F841: –∑–º—ñ–Ω–Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞, –∞–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.",
}


def run_flake8(targets, exclude=None, output=None):
    """
    –ó–∞–ø—É—Å–∫–∞—î flake8 –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
    targets: —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤/–ø–∞–ø–æ–∫
    exclude: —Å–ø–∏—Å–æ–∫ –≤–∏–∫–ª—é—á–µ–Ω–∏—Ö —à–ª—è—Ö—ñ–≤
    output: —Ñ–∞–π–ª –¥–ª—è –ª–æ–≥—ñ–≤ (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ)
    """
    cmd = [
        "flake8",
        "--show-source",
        "--statistics",
        "--count",
        "--max-line-length=88",
    ]

    if exclude:
        cmd.append(f"--exclude={','.join(exclude)}")

    cmd.extend(targets)

    if shutil.which("flake8") is None:
        print("‚ùå flake8 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤–∏ –π–æ–≥–æ: pip install flake8")
        return 2

    # –ó–∞–ø—É—Å–∫–∞—î–º–æ flake8 —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ stdout
    result = subprocess.run(cmd, capture_output=True, text=True)
    output_text = result.stdout

    # –í–∏–≤–æ–¥–∏–º–æ –Ω–∞ –µ–∫—Ä–∞–Ω
    print(output_text)

    # –Ø–∫—â–æ —Ç—Ä–µ–±–∞ ‚Äî –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —É —Ñ–∞–π–ª
    if output:
        with open(output, "w", encoding="utf-8") as f:
            f.write(output_text)
        print(f"üìÑ –õ–æ–≥ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ñ–∞–π–ª: {output}")

    # –î–æ–¥–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –ø–æ–º–∏–ª–æ–∫
    for code, hint in HINTS.items():
        if code in output_text:
            print(f"üí° –ü—ñ–¥–∫–∞–∑–∫–∞ –¥–ª—è {code}: {hint}")

    return result.returncode


def main():
    parser = argparse.ArgumentParser(
        description="–ó–∞–ø—É—Å–∫ flake8 –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–º –≤–∏–≤–æ–¥–æ–º —Ç–∞ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏."
    )
    parser.add_argument("targets", nargs="+", help="–§–∞–π–ª–∏ –∞–±–æ –ø–∞–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏")
    parser.add_argument(
        "--exclude",
        nargs="+",
        help="–°–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫/—Ñ–∞–π–ª—ñ–≤ –¥–ª—è –≤–∏–∫–ª—é—á–µ–Ω–Ω—è (—á–µ—Ä–µ–∑ –ø—Ä–æ–±—ñ–ª)",
    )
    parser.add_argument(
        "--output",
        help="–§–∞–π–ª –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–≤—ñ—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: report.txt)",
    )

    args = parser.parse_args()

    rc = run_flake8(args.targets, exclude=args.exclude, output=args.output)
    sys.exit(rc)


if __name__ == "__main__":
    main()
